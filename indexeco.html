<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ecosistema Cultural (Conectado)</title>
  
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- UI SÓLIDA (Siempre visible) --- */
    body { margin: 0; background: #121212; font-family: 'Inter', sans-serif; overflow: hidden; }
    #ecosistema-vis { width: 100vw; height: 100vh; background: radial-gradient(circle, #1e1e1e 0%, #000 100%); }

    /* BARRA LATERAL (Estilo Bacon) */
    .sidebar {
      position: absolute; top: 0; left: 0; width: 250px; height: 100%;
      background: rgba(20,20,20,0.95); border-right: 1px solid #333;
      padding: 20px; box-sizing: border-box; z-index: 100;
      transform: translateX(0); transition: transform 0.3s ease;
      display: flex; flex-direction: column;
    }
    .sidebar.closed { transform: translateX(-250px); }
    
    h2 { color: #E9C46A; margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Filtros */
    #filters-container { flex: 1; overflow-y: auto; }
    .filter-row { display: flex; align-items: center; margin-bottom: 12px; color: #ccc; font-size: 12px; cursor: pointer; }
    .filter-row:hover { color: #fff; }
    .checkbox { width: 16px; height: 16px; border: 1px solid #555; margin-right: 10px; display: flex; align-items: center; justify-content: center; border-radius: 3px;}
    .checkbox.checked { background: #E9C46A; border-color: #E9C46A; color: black; }
    
    /* BARRA SUPERIOR (Herramientas) */
    .top-bar {
      position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; gap: 10px;
    }
    .btn {
      background: #222; color: white; border: 1px solid #444; padding: 10px 16px;
      border-radius: 8px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }
    .btn:hover { border-color: #E9C46A; color: #E9C46A; }
    .btn.active { background: #E9C46A; color: black; font-weight: bold; }

    /* POPUP DE EDICIÓN */
    #editor-popup {
      display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #1a1a1a; border: 2px solid #E9C46A; padding: 20px; width: 280px;
      z-index: 200; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }
    label { display: block; color: #888; font-size: 11px; margin-bottom: 5px; margin-top: 10px;}
    select, input { width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
    
    /* NOTIFICACIONES */
    #toast {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: #4CAF50; color: white; padding: 10px 20px; border-radius: 20px;
      font-size: 12px; display: none; z-index: 300; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    
    /* LOADING */
    #loading-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #121212; z-index: 50; display: flex; justify-content: center; align-items: center;
        flex-direction: column; color: #E9C46A; font-weight: bold; letter-spacing: 2px;
    }
  </style>
</head>
<body>

<div id="loading-screen">
    <div>CARGANDO ECOSISTEMA...</div>
    <div style="font-size:10px; color:#666; margin-top:10px">Conectando a Google Sheets</div>
</div>

<div class="sidebar" id="sidebar">
  <h2>Filtros / Capas</h2>
  <div id="filters-container">
    </div>
  <div style="margin-top:auto; border-top:1px solid #333; padding-top:20px;">
    <input type="text" id="search" placeholder="Buscar nodo..." style="box-sizing:border-box;" onkeyup="doSearch()">
  </div>
</div>

<div class="top-bar">
  <button class="btn" id="btn-mode" onclick="toggleEditMode()">
    <i class="fa-solid fa-pen-nib"></i> Modo Edición
  </button>
  <button class="btn" onclick="location.reload()">
    <i class="fa-solid fa-rotate-right"></i>
  </button>
</div>

<div id="editor-popup">
  <h3 style="margin:0 0 15px 0; color:#E9C46A;">Nueva Relación</h3>
  
  <label>Tipo de Conexión:</label>
  <select id="rel-type">
    <option value="jerarquia">Jerarquía (Presidente/Director)</option>
    <option value="financiamiento">Financiamiento ($)</option>
    <option value="comercial">Representación / Comercial</option>
    <option value="premio">Premio / Beca</option>
    <option value="pareja">Pareja / Familiar</option>
  </select>

  <label>Etiqueta (Opcional):</label>
  <input type="text" id="rel-label" placeholder="Ej: Ganador 2024">

  <div style="display:flex; gap:10px; margin-top:20px;">
    <button class="btn" style="flex:1; background:#E9C46A; color:black; justify-content:center;" id="btn-save">GUARDAR</button>
    <button class="btn" style="flex:1; background:transparent; justify-content:center;" onclick="closePopup()">Cancelar</button>
  </div>
</div>

<div id="toast"><i class="fa-solid fa-check"></i> Guardado en Google Sheets</div>

<div id="ecosistema-vis"></div>

<script type="text/javascript">

  // ====================================================
  // 1. CONFIGURACIÓN
  // ====================================================
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrlo_1Cs9WW3zJFmPy4kkJU6jRnOqc4M-7AwvcPjjGroHr9Nv48lh3mxUZtpOmOeHu/exec";
  
  const URL_NODOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5NA31GzQIJ631B8M_5gg9yu-SDwTRGu91jPbB2coNLGhBVju33RTui2pYo5y2mAEt8M8GnHcISj4H/pub?gid=0&single=true&output=csv";
  const URL_RELACIONES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5NA31GzQIJ631B8M_5gg9yu-SDwTRGu91jPbB2coNLGhBVju33RTui2pYo5y2mAEt8M8GnHcISj4H/pub?gid=1078940281&single=true&output=csv";
  const PROXY = "https://corsproxy.io/?";

  var nodes = new vis.DataSet([]);
  var edges = new vis.DataSet([]);
  var network = null;
  var allNodesData = [];

  const colors = {
    fondo_publico: '#81B29A', persona: '#E9C46A', fundacion: '#A2D2FF',
    corporacion: '#A2D2FF', espacio_comercial: '#E07A5F', espacio_privado: '#E07A5F',
    espacio_no_comercial: '#E76F51', estado: '#F2CC8F', premio: '#DBF4A7',
    gremio: '#9B5DE5', otro: '#888'
  };

  // --- CARGA ---
  function init() {
    const pN = PROXY + encodeURIComponent(URL_NODOS);
    const pR = PROXY + encodeURIComponent(URL_RELACIONES);

    Promise.all([
      fetch(pN).then(r => r.text()),
      fetch(pR).then(r => r.text())
    ]).then(([txtNodos, txtRel]) => {
      
      // NODOS
      let parsedN = Papa.parse(txtNodos, {header:true, skipEmptyLines:true}).data;
      let cleanN = parsedN.filter(x => x.id).map(n => {
        let grp = n.group || 'otro';
        let col = colors[grp] || '#888';
        let shape = (grp === 'persona') ? 'circularImage' : (grp==='gremio'?'diamond':'box');
        let img = (grp === 'persona' && !n.image) ? `https://ui-avatars.com/api/?name=${n.label}&background=${col.replace('#','')}&color=000` : n.image;
        
        return {
          id: n.id, label: n.label, group: grp, shape: shape, image: img,
          color: { background: col, border: col },
          value: parseInt(n.val_size) || 25,
          title: n.label
        };
      });
      
      allNodesData = cleanN;
